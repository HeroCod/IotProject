services:

  contiki-ng:
    container_name: contiki-ng
    build:
      context: ./contiki-container
      dockerfile: Dockerfile
      args:
        - INSTALL_TOOLS=1
    cap_add:
      - NET_ADMIN
      - NET_RAW
    # sysctls:
    #   - net.ipv4.ip_forward=1
    #   - net.ipv6.conf.all.disable_ipv6=0
    #   - net.ipv6.conf.all.forwarding=1
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
      - $HOME/.Xauthority:/root/.Xauthority
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DISPLAY=${DISPLAY}
    network_mode: host
    # networks:
    #   iot-network:
    #     ipv6_address: fd00:1::2
    privileged: true
    command: sleep infinity

  # MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: iot_mosquitto
    stdin_open: true
    tty: true
    devices:
      - /dev/net/tun:/dev/net/tun
    # ports:
    #     - 1883:1883
    volumes:
        - ./mosquitto/config:/mosquitto/config
        - ./mosquitto/data:/mosquitto/data
        - ./mosquitto/log:/mosquitto/log
    network_mode: host
    # networks:
    #   iot-network:
    #     ipv6_address: fd00:1::3
    restart: unless-stopped

  # IoT Controller Backend (with REST API)
  controller:
    build: ./controller
    container_name: iot_controller
    depends_on:
      mosquitto:
        condition: service_started
      mysql:
        condition: service_healthy
    volumes:
      - ./ml:/app/ml:ro  # Mount ML parameters as read-only
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      MQTT_BROKER: localhost
      MQTT_PORT: 1883
      MYSQL_HOST: localhost
      MYSQL_PORT: 3306
      MYSQL_USER: iotuser
      MYSQL_PASSWORD: iotpass
      MYSQL_DB: iotdb
    network_mode: host
    # ports:
    #   - "5001:5001"
    # networks:
    #   iot-network:
    #     ipv6_address: fd00:1::4
    restart: unless-stopped

  # Web Application Frontend
  webapp:
    build: ./webapp
    container_name: iot_webapp
    depends_on:
      controller:
        condition: "service_started"
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      CONTROLLER_API: http://localhost:5001
      WEBAPP_PORT: 5000
    # ports:
    #   - "5000:5000"
    network_mode: host
    # networks:
    #   iot-network:
    #     ipv6_address: fd00:1::5
    restart: unless-stopped


  # MySQL Database
  mysql:
    image: mysql:8
    container_name: iot_mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: iotdb
      MYSQL_USER: iotuser
      MYSQL_PASSWORD: iotpass
    # ports:
    #   - "3306:3306"
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - db_data:/var/lib/mysql
    network_mode: host
    # networks:
    #   iot-network:
    #     ipv6_address: fd00:1::6
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p$${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  db_data:

# networks:
#   iot-network:
#     enable_ipv6: true
#     ipam:
#       config:
#         - subnet: fd00:1::/64
#           gateway: fd00:1::1
#     name: iot-network
#     driver: host
