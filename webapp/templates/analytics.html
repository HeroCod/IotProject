<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Analytics - IoT System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .nav-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .nav-link {
            color: #3498db;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .nav-link:hover {
            background: rgba(52, 152, 219, 0.1);
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-consumption {
            color: #e74c3c;
        }
        
        .stat-saved {
            color: #27ae60;
        }
        
        .stat-efficiency {
            color: #3498db;
        }
        
        .stat-events {
            color: #f39c12;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .time-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .time-btn {
            padding: 8px 16px;
            border: 2px solid #3498db;
            background: transparent;
            color: #3498db;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .time-btn.active,
        .time-btn:hover {
            background: #3498db;
            color: white;
        }
        
        .insights-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .insight-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .insight-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
        }
        
        .insight-text {
            flex: 1;
        }
        
        .insight-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .insight-description {
            font-size: 14px;
            color: #666;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
        }
        
        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
                margin-bottom: 8px;
            }
            
            .header p {
                font-size: 14px;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .chart-container {
                height: 200px;
            }
            
            .insights-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .insight-item {
                padding: 12px;
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }
            
            .insight-icon {
                font-size: 20px;
                width: auto;
            }
            
            .insight-title {
                font-size: 14px;
            }
            
            .insight-description {
                font-size: 12px;
            }
            
            .nav-links {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-link {
                width: 100%;
                text-align: center;
                max-width: 200px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .card {
                padding: 12px;
            }
            
            .chart-container {
                height: 180px;
            }
            
            .insight-item {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà Energy Analytics Dashboard</h1>
            <p>Advanced analytics and insights for IoT energy optimization</p>
            
            <div class="nav-links">
                <a href="/" class="nav-link">üìä Dashboard</a>
                <a href="/analytics" class="nav-link">üìà Analytics</a>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value stat-consumption" id="total-consumption">0.000</div>
                <div class="stat-label">Total Consumption (kWh)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value stat-saved" id="energy-saved">0.000</div>
                <div class="stat-label">Energy Saved (kWh)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value stat-efficiency" id="efficiency">0.0</div>
                <div class="stat-label">Efficiency Improvement (%)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value stat-events" id="optimization-events">0</div>
                <div class="stat-label">Optimization Events</div>
            </div>
        </div>
        
        <div class="analytics-grid">
            <div class="chart-card">
                <div class="chart-title">üìä Energy Consumption by Room</div>
                <div class="chart-container">
                    <canvas id="roomConsumptionChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">üïê Hourly Energy Pattern</div>
                <div class="chart-container">
                    <canvas id="hourlyPatternChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">üå°Ô∏è Temperature Trends</div>
                <div class="chart-container">
                    <canvas id="temperatureTrendChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">üí° Light Level Analysis</div>
                <div class="chart-container">
                    <canvas id="lightAnalysisChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">üë§ Occupancy Patterns</div>
                <div class="chart-container">
                    <canvas id="occupancyPatternChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">‚ö° Energy Efficiency Score</div>
                <div class="chart-container">
                    <canvas id="efficiencyChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card full-width">
                <div class="chart-title">üìà Historical Energy Trends</div>
                <div class="time-controls">
                    <button class="time-btn" onclick="loadHistoricalData(1)">Last Hour</button>
                    <button class="time-btn active" onclick="loadHistoricalData(6)">Last 6 Hours</button>
                    <button class="time-btn" onclick="loadHistoricalData(24)">Last 24 Hours</button>
                </div>
                <div class="chart-container">
                    <canvas id="historicalChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="insights-card">
            <h3 class="chart-title">üí° AI-Powered Insights</h3>
            <div id="insights-container">
                <!-- Insights will be dynamically generated -->
            </div>
        </div>
    </div>

    <script>
        let roomChart, hourlyChart, historicalChart;
        let currentTimeRange = 1;
        
        // Initialize charts
        function initializeCharts() {
            // Room consumption pie chart
            const roomCtx = document.getElementById('roomConsumptionChart').getContext('2d');
            roomChart = new Chart(roomCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Living Room', 'Kitchen', 'Bedroom'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#3498db', '#e74c3c', '#27ae60'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Hourly pattern bar chart
            const hourlyCtx = document.getElementById('hourlyPatternChart').getContext('2d');
            hourlyChart = new Chart(hourlyCtx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Average Consumption',
                        data: new Array(24).fill(0),
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Energy (kWh)'
                            }
                        }
                    }
                }
            });
            
            // Historical trends line chart
            const historicalCtx = document.getElementById('historicalChart').getContext('2d');
            historicalChart = new Chart(historicalCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Living Room',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Kitchen',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Bedroom',
                        data: [],
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Energy Consumption (kWh)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
            
            // Temperature Trend Chart
            const tempTrendCtx = document.getElementById('temperatureTrendChart').getContext('2d');
            const temperatureTrendChart = new Chart(tempTrendCtx, {
                type: 'line',
                data: {
                    labels: ['6h ago', '5h ago', '4h ago', '3h ago', '2h ago', '1h ago', 'Now'],
                    datasets: [{
                        label: 'Average Temperature',
                        data: [22, 23, 21, 24, 22, 23, 22],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 18,
                            max: 28,
                            title: { display: true, text: 'Temperature (¬∞C)' }
                        }
                    }
                }
            });
            
            // Light Analysis Chart
            const lightAnalysisCtx = document.getElementById('lightAnalysisChart').getContext('2d');
            const lightAnalysisChart = new Chart(lightAnalysisCtx, {
                type: 'bar',
                data: {
                    labels: ['Morning', 'Noon', 'Afternoon', 'Evening', 'Night'],
                    datasets: [{
                        label: 'Average Light Level',
                        data: [45, 85, 70, 30, 15],
                        backgroundColor: ['#f39c12', '#f1c40f', '#e67e22', '#8e44ad', '#2c3e50']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Light Level (Lux)' }
                        }
                    }
                }
            });
            
            // Occupancy Pattern Chart
            const occupancyPatternCtx = document.getElementById('occupancyPatternChart').getContext('2d');
            const occupancyPatternChart = new Chart(occupancyPatternCtx, {
                type: 'radar',
                data: {
                    labels: ['Living Room', 'Kitchen', 'Bedroom'],
                    datasets: [{
                        label: 'Occupancy Rate (%)',
                        data: [65, 75, 45],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.2)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { stepSize: 20 }
                        }
                    }
                }
            });
            
            // Efficiency Chart
            const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
            const efficiencyChart = new Chart(efficiencyCtx, {
                type: 'gauge',
                data: {
                    datasets: [{
                        data: [75, 25],
                        backgroundColor: ['#27ae60', '#ecf0f1']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    circumference: 180,
                    rotation: 270,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }
        
        // Load and update statistics
        function updateStatistics() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    const stats = data.energy_stats;
                    
                    document.getElementById('total-consumption').textContent = stats.total_consumption.toFixed(3);
                    document.getElementById('energy-saved').textContent = stats.energy_saved.toFixed(3);
                    document.getElementById('optimization-events').textContent = stats.optimization_events;
                    
                    // Calculate efficiency improvement
                    const efficiency = stats.total_consumption > 0 
                        ? (stats.energy_saved / stats.total_consumption * 100) 
                        : 0;
                    document.getElementById('efficiency').textContent = efficiency.toFixed(1);
                    
                    // Update room consumption chart
                    updateRoomConsumption(data.latest_data);
                })
                .catch(error => console.error('Error fetching statistics:', error));
        }
        
        // Update room consumption chart
        function updateRoomConsumption(latestData) {
            const roomData = [0, 0, 0]; // Living Room, Kitchen, Bedroom
            
            Object.entries(latestData || {}).forEach(([deviceId, deviceData]) => {
                const consumption = deviceData.data.room_usage || 0;
                
                if (deviceId === 'node1') roomData[0] = consumption;
                else if (deviceId === 'node2') roomData[1] = consumption;
                else if (deviceId === 'node3') roomData[2] = consumption;
            });
            
            roomChart.data.datasets[0].data = roomData;
            roomChart.update();
        }
        
        // Load historical data
        function loadHistoricalData(hours) {
            currentTimeRange = hours;
            
            // Update button states
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            fetch(`/api/historical/${hours}`)
                .then(response => response.json())
                .then(data => {
                    updateHistoricalChart(data.data);
                    updateHourlyPattern(data.data);
                    generateInsights(data.data);
                })
                .catch(error => console.error('Error fetching historical data:', error));
        }
        
        // Update historical chart
        function updateHistoricalChart(historicalData) {
            const deviceData = {
                node1: { labels: [], data: [] },
                node2: { labels: [], data: [] },
                node3: { labels: [], data: [] }
            };
            
            // Group data by device and sort by timestamp
            historicalData.forEach(item => {
                const deviceId = item.device_id;
                const timestamp = new Date(item.timestamp).toLocaleTimeString();
                const consumption = item.data.room_usage || 0;
                
                if (deviceData[deviceId]) {
                    deviceData[deviceId].labels.push(timestamp);
                    deviceData[deviceId].data.push(consumption);
                }
            });
            
            // Use data from the first device for labels (assuming synchronized timestamps)
            const labels = deviceData.node1.labels.slice(-50); // Last 50 data points
            
            historicalChart.data.labels = labels;
            historicalChart.data.datasets[0].data = deviceData.node1.data.slice(-50);
            historicalChart.data.datasets[1].data = deviceData.node2.data.slice(-50);
            historicalChart.data.datasets[2].data = deviceData.node3.data.slice(-50);
            
            historicalChart.update();
        }
        
        // Update hourly pattern chart
        function updateHourlyPattern(historicalData) {
            const hourlyData = new Array(24).fill(0);
            const hourlyCounts = new Array(24).fill(0);
            
            historicalData.forEach(item => {
                const hour = new Date(item.timestamp).getHours();
                const consumption = item.data.room_usage || 0;
                
                hourlyData[hour] += consumption;
                hourlyCounts[hour]++;
            });
            
            // Calculate averages
            const averages = hourlyData.map((total, index) => 
                hourlyCounts[index] > 0 ? total / hourlyCounts[index] : 0
            );
            
            hourlyChart.data.datasets[0].data = averages;
            hourlyChart.update();
        }
        
        // Generate AI insights
        function generateInsights(historicalData) {
            const container = document.getElementById('insights-container');
            const insights = [];
            
            // Calculate basic statistics
            const totalConsumption = historicalData.reduce((sum, item) => 
                sum + (item.data.room_usage || 0), 0);
            const avgConsumption = totalConsumption / Math.max(historicalData.length, 1);
            
            // Energy waste detection
            const wasteEvents = historicalData.filter(item => 
                item.data.occupancy === 0 && (item.data.room_usage || 0) > 0.05);
            
            if (wasteEvents.length > 0) {
                insights.push({
                    icon: '‚ö†Ô∏è',
                    title: 'Energy Waste Detected',
                    description: `Found ${wasteEvents.length} instances where lights were on in unoccupied rooms. Potential savings: ${(wasteEvents.length * 0.05).toFixed(3)} kWh`
                });
            }
            
            // Optimization events
            const optimizationEvents = historicalData.filter(item => 
                item.data.energy_saving_mode === 1);
            
            if (optimizationEvents.length > 0) {
                insights.push({
                    icon: 'üíö',
                    title: 'Energy Optimization Active',
                    description: `ML system activated energy saving ${optimizationEvents.length} times, preventing unnecessary energy consumption`
                });
            }
            
            // Manual overrides analysis
            const manualEvents = historicalData.filter(item => 
                item.data.manual_override === 1);
            
            if (manualEvents.length > 0) {
                insights.push({
                    icon: 'üîß',
                    title: 'Manual Control Usage',
                    description: `Users manually controlled lights ${manualEvents.length} times. Consider reviewing user preferences for better automation`
                });
            }
            
            // Ambient light optimization
            const ambientOptimizations = historicalData.filter(item => 
                (item.data.lux || 0) >= 65 && item.data.led_status === 0);
            
            if (ambientOptimizations.length > 0) {
                insights.push({
                    icon: '‚òÄÔ∏è',
                    title: 'Ambient Light Optimization',
                    description: `Ambient light prevented unnecessary lighting ${ambientOptimizations.length} times when natural light was sufficient`
                });
            }
            
            // Peak usage analysis
            const highConsumption = historicalData.filter(item => 
                (item.data.room_usage || 0) > avgConsumption * 1.5);
            
            if (highConsumption.length > 0) {
                insights.push({
                    icon: 'üìä',
                    title: 'Peak Usage Analysis',
                    description: `${highConsumption.length} high consumption events detected. Average usage: ${avgConsumption.toFixed(3)} kWh`
                });
            }
            
            // Default insight if no specific patterns found
            if (insights.length === 0) {
                insights.push({
                    icon: '‚úÖ',
                    title: 'System Operating Normally',
                    description: 'No significant energy waste patterns detected. The ML optimization system is working efficiently.'
                });
            }
            
            // Render insights
            container.innerHTML = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-icon">${insight.icon}</div>
                    <div class="insight-text">
                        <div class="insight-title">${insight.title}</div>
                        <div class="insight-description">${insight.description}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            updateStatistics();
            loadHistoricalData(6);
            
            // Auto-refresh every 30 seconds
            setInterval(updateStatistics, 30000);
        });
    </script>
</body>
</html>
