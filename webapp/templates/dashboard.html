<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Energy Monitoring Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .status-indicators {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-online {
            background: #d4edda;
            color: #155724;
        }
        
        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sensor-card {
            border-left: 4px solid #3498db;
        }
        
        .energy-card {
            border-left: 4px solid #27ae60;
        }
        
        .control-card {
            border-left: 4px solid #e74c3c;
        }
        
        .sensor-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .sensor-value {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .sensor-value .label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .sensor-value .value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .energy-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #27ae60;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-on {
            background: #27ae60;
            color: white;
        }
        
        .btn-off {
            background: #e74c3c;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .chart-container {
            height: 250px;
            position: relative;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .nav-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .nav-link {
            color: #3498db;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .nav-link:hover {
            background: rgba(52, 152, 219, 0.1);
        }
        
        .led-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .led-on {
            background: #27ae60;
            box-shadow: 0 0 8px #27ae60;
        }
        
        .led-off {
            background: #95a5a6;
        }
        
        .manual-mode {
            background: #f39c12;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 10px;
        }
        
        .timestamp {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }
        
        .override-info {
            margin: 10px 0;
            padding: 8px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .duration-select {
            width: 100%;
            padding: 6px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            background: white;
            margin-bottom: 8px;
        }
        
        /* Global Controls Styles */
        .global-controls-card {
            margin-top: 20px;
            border-left: 4px solid #e74c3c;
        }
        
        .global-controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .control-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .control-group h4 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 16px;
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .optimizer-status {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .energy-mode-info p {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .response-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            display: none;
        }
        
        .response-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .response-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .response-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }
        
        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
                margin-bottom: 8px;
            }
            
            .header p {
                font-size: 14px;
            }
            
            .grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .sensor-data {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .sensor-value {
                padding: 8px;
            }
            
            .sensor-value .label {
                font-size: 11px;
            }
            
            .sensor-value .value {
                font-size: 16px;
            }
            
            .control-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .btn {
                padding: 10px;
                font-size: 14px;
            }
            
            .chart-container {
                height: 200px;
            }
            
            .global-controls-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .control-group {
                padding: 12px;
            }
            
            .control-group h4 {
                font-size: 14px;
                margin-bottom: 10px;
            }
            
            .energy-mode-info p {
                font-size: 12px;
            }
            
            .status-indicators {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            
            .status-indicator {
                width: 100%;
                justify-content: center;
                max-width: 300px;
            }
            
            .nav-links {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .sensor-data {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: 12px;
            }
            
            .chart-container {
                height: 180px;
            }
            
            .control-group {
                padding: 10px;
            }
            
            .btn {
                padding: 8px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Smart Home Energy Monitoring Dashboard</h1>
            <p>Real-time IoT sensor monitoring with AI-powered energy optimization</p>
            
            <div class="status-indicators">
                <div class="status-indicator" id="mqtt-status">
                    <span>üîå</span> MQTT: <span id="mqtt-text">Connecting...</span>
                </div>
                <div class="status-indicator" id="db-status">
                    <span>üóÑÔ∏è</span> Database: <span id="db-text">Connecting...</span>
                </div>
                <div class="status-indicator" id="nodes-status">
                    <span>üì°</span> Nodes Online: <span id="nodes-count">0</span>
                </div>
                <div class="status-indicator" id="ai-status">
                    <span>ü§ñ</span> AI Optimizer: <span id="ai-text">Initializing...</span>
                </div>
            </div>
            
            <div class="nav-links">
                <a href="/" class="nav-link">üìä Dashboard</a>
                <a href="/analytics" class="nav-link">üìà Analytics</a>
            </div>
        </div>
        
        <div class="grid">
            <!-- Energy Statistics Card -->
            <div class="card energy-card">
                <h3>‚ö° Energy Statistics</h3>
                <div class="energy-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="total-consumption">0.000</div>
                        <div class="stat-label">Total Consumption (kWh)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="energy-saved">0.000</div>
                        <div class="stat-label">Energy Saved (kWh)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="optimization-events">0</div>
                        <div class="stat-label">Optimization Events</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="manual-overrides">0</div>
                        <div class="stat-label">Manual Overrides</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts Grid - Half Page Layout -->
        <div class="chart-grid">
            <div class="card chart-container">
                <h3>üìà Real-time Energy Consumption</h3>
                <canvas id="energyChart"></canvas>
            </div>
            
            <!-- Temperature Chart -->
            <div class="card chart-container">
                <h3>üå°Ô∏è Temperature Monitoring</h3>
                <canvas id="temperatureChart"></canvas>
            </div>
            
            <!-- Light Levels Chart -->
            <div class="card chart-container">
                <h3>üí° Light Levels (Lux)</h3>
                <canvas id="lightChart"></canvas>
            </div>
            
            <!-- Occupancy Chart -->
            <div class="card chart-container">
                <h3>üë§ Occupancy Status</h3>
                <canvas id="occupancyChart"></canvas>
            </div>
        </div>
        
        <!-- Dynamic sensor cards will be inserted here -->
        <div class="grid" id="sensor-cards">
        </div>
        
        <!-- Global Controls Section -->
        <div class="card global-controls-card">
            <h3>üåê System Controls</h3>
            <div class="global-controls-grid">
                <div class="control-group">
                    <h4>üí° All Devices</h4>
                    <div class="control-buttons">
                        <button class="btn btn-success" onclick="globalCommand('all', 'on')">
                            üí° All Lights ON
                        </button>
                        <button class="btn btn-danger" onclick="globalCommand('all', 'off')">
                            üåô All Lights OFF
                        </button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h4>ü§ñ AI Optimizer</h4>
                    <div class="optimizer-status">
                        <div class="status-indicator" id="optimizer-status">
                            <span class="status-dot status-online"></span>
                            <span>ML Optimizer Active</span>
                        </div>
                        <div class="control-buttons">
                            <button class="btn btn-warning" onclick="refreshOptimizer()">
                                üîÑ Refresh System
                            </button>
                            <button class="btn btn-success" onclick="enableOptimizer()">
                                ‚úÖ Re-enable Optimizer
                            </button>
                        </div>
                        <button class="btn" onclick="window.location.href='/optimizer'" style="margin-top: 8px; width: 100%; background: #6c757d; color: white;">
                            üìä View Details
                        </button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h4>‚ö° Energy Mode</h4>
                    <div class="energy-mode-info">
                        <p>Energy saving mode is automatically managed by the AI system based on occupancy patterns, ambient light, and user preferences.</p>
                        <div class="control-buttons">
                            <button class="btn btn-info" onclick="showEnergyModeInfo()">
                                üìä View Statistics
                            </button>
                            <button class="btn" onclick="resetChartScales()" style="background: #6c757d; color: white;">
                                üìà Reset Chart Scales
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="response-message" id="global-response"></div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO connection
        const socket = io();
        
        // Peak value tracking for charts
        let chartPeaks = {
            energy: 0.2,      // Minimum scale for energy chart
            temperature: 30,   // Maximum scale for temperature chart
            light: 100,       // Maximum scale for light chart
            occupancy: 1.2    // Fixed scale for occupancy chart
        };
        
        // Chart configuration
        const ctx = document.getElementById('energyChart').getContext('2d');
        const energyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Living Room',
                    data: [],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Kitchen',
                    data: [],
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Bedroom',
                    data: [],
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: chartPeaks.energy,
                        title: {
                            display: true,
                            text: 'Energy Consumption (kWh)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
        
        // Temperature Chart
        const tempCtx = document.getElementById('temperatureChart').getContext('2d');
        const temperatureChart = new Chart(tempCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Living Room',
                    data: [],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Kitchen',
                    data: [],
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Bedroom',
                    data: [],
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 15,
                        max: chartPeaks.temperature,
                        title: {
                            display: true,
                            text: 'Temperature (¬∞C)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
        
        // Light Levels Chart
        const lightCtx = document.getElementById('lightChart').getContext('2d');
        const lightChart = new Chart(lightCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Living Room',
                    data: [],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Kitchen',
                    data: [],
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Bedroom',
                    data: [],
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: chartPeaks.light,
                        title: {
                            display: true,
                            text: 'Light Level (Lux)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
        
        // Occupancy Chart
        const occupancyCtx = document.getElementById('occupancyChart').getContext('2d');
        const occupancyChart = new Chart(occupancyCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Living Room',
                    data: [],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    stepped: true
                }, {
                    label: 'Kitchen',
                    data: [],
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.4,
                    stepped: true
                }, {
                    label: 'Bedroom',
                    data: [],
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    tension: 0.4,
                    stepped: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1.2,
                        ticks: {
                            stepSize: 1,
                            callback: function(value) {
                                return value === 1 ? 'Occupied' : value === 0 ? 'Empty' : '';
                            }
                        },
                        title: {
                            display: true,
                            text: 'Occupancy Status'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
        
        // Update system status
        function updateStatus(status) {
            const mqttStatus = document.getElementById('mqtt-status');
            const dbStatus = document.getElementById('db-status');
            const aiStatus = document.getElementById('ai-status');
            const mqttText = document.getElementById('mqtt-text');
            const dbText = document.getElementById('db-text');
            const aiText = document.getElementById('ai-text');
            const nodesCount = document.getElementById('nodes-count');
            
            mqttStatus.className = `status-indicator ${status.system_status.mqtt_connected ? 'status-online' : 'status-offline'}`;
            mqttText.textContent = status.system_status.mqtt_connected ? 'Connected' : 'Disconnected';
            
            dbStatus.className = `status-indicator ${status.system_status.db_connected ? 'status-online' : 'status-offline'}`;
            dbText.textContent = status.system_status.db_connected ? 'Connected' : 'Disconnected';
            
            // AI status based on optimization events
            const aiActive = status.energy_stats.optimization_events > 0;
            aiStatus.className = `status-indicator ${aiActive ? 'status-online' : 'status-warning'}`;
            aiText.textContent = aiActive ? 'Active' : 'Inactive';
            
            nodesCount.textContent = status.system_status.nodes_online || 0;
        }
        
        // Update energy statistics
        function updateEnergyStats(stats) {
            document.getElementById('total-consumption').textContent = stats.total_consumption.toFixed(3);
            document.getElementById('energy-saved').textContent = stats.energy_saved.toFixed(3);
            document.getElementById('optimization-events').textContent = stats.optimization_events;
            document.getElementById('manual-overrides').textContent = stats.manual_overrides;
        }
        
        // Create or update sensor card
        function updateSensorCard(deviceId, data, timestamp, type) {
            console.log(`üîß Updating card for ${deviceId}:`, data);
            
            const container = document.getElementById('sensor-cards');
            let card = document.getElementById(`card-${deviceId}`);
            
            if (!card) {
                card = document.createElement('div');
                card.className = 'card sensor-card';
                card.id = `card-${deviceId}`;
                container.appendChild(card);
                console.log(`‚ú® Created new card for ${deviceId}`);
            }
            
            const location = data.location || deviceId;
            const isOccupied = data.occupancy === 1;
            const ledStatus = data.led_status ? 'led-on' : 'led-off';
            const manualMode = data.manual_override ? '<span class="manual-mode">MANUAL</span>' : '';
            
            // Check online status (similar to control page logic)
            let isOnline = false;
            if (timestamp) {
                try {
                    // Ensure timestamp is treated as UTC if it doesn't have timezone info
                    let timestampToUse = timestamp;
                    if (!timestamp.includes('Z') && !timestamp.includes('+') && !timestamp.includes('-', 10)) {
                        timestampToUse = timestamp + 'Z'; // Add UTC indicator
                    }
                    
                    const deviceTime = new Date(timestampToUse).getTime();
                    const currentTime = Date.now();
                    const timeDiff = currentTime - deviceTime;
                    
                    // More generous timeout - 60 seconds
                    isOnline = !isNaN(deviceTime) && timeDiff < 60000 && timeDiff >= 0;
                } catch (e) {
                    console.error(`Device ${deviceId} timestamp parse error:`, e);
                    isOnline = false;
                }
            }
            
            // Check if device has override (fetch from API)
            fetchDeviceOverride(deviceId).then(override => {
                const overrideInfo = override?.active ? `
                    <div class="override-info" style="margin: 10px 0; padding: 8px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; font-size: 12px;">
                        <strong>Override Active:</strong> ${override.status.toUpperCase()} 
                        (${override.type}${override.expires_at ? ' - expires: ' + new Date(override.expires_at + 'Z').toLocaleString() : ''})
                    </div>
                ` : '';
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin: 0;">
                            üè† ${location.charAt(0).toUpperCase() + location.slice(1)}
                            <span class="led-status ${ledStatus}"></span>
                            ${manualMode}
                        </h3>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background-color: ${isOnline ? '#27ae60' : '#e74c3c'};"></div>
                            <span style="font-size: 12px; color: ${isOnline ? '#27ae60' : '#e74c3c'}; font-weight: bold;">${isOnline ? 'Online' : 'Offline'}</span>
                        </div>
                    </div>
                    
                    <!-- Mode Indicators -->
                    <div style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
                        <div style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; ${override?.active ? 'background: #fff3cd; color: #856404;' : 'background: #d4edda; color: #155724;'}">
                            ${override?.active ? 'üîß Manual Mode' : 'ü§ñ Auto Mode'}
                        </div>
                        ${data.energy_saving_mode ? '<div style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; background: #d1ecf1; color: #0c5460;">üíö Energy Saving</div>' : ''}
                        ${data.led_status ? '<div style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; background: #ffebcd; color: #8b4513;">üí° LED ON</div>' : ''}
                    </div>
                    
                    <div class="sensor-data">
                        <div class="sensor-value">
                            <div class="label">üí° Light</div>
                            <div class="value">${data.lux || 'N/A'} lux</div>
                        </div>
                        <div class="sensor-value">
                            <div class="label">üë§ Occupancy</div>
                            <div class="value">${isOccupied ? '‚úÖ Yes' : '‚ùå No'}</div>
                        </div>
                        <div class="sensor-value">
                            <div class="label">üå°Ô∏è Temperature</div>
                            <div class="value">${data.temperature ? data.temperature.toFixed(1) : 'N/A'}¬∞C</div>
                        </div>
                        <div class="sensor-value">
                            <div class="label">‚ö° Usage</div>
                            <div class="value">${(data.room_usage || 0).toFixed(3)} kWh</div>
                        </div>
                        <div class="sensor-value">
                            <div class="label">üîò Button</div>
                            <div class="value">${data.button_presses || 0}</div>
                        </div>
                        <div class="sensor-value">
                            <div class="label">üÜî Node ID</div>
                            <div class="value">${deviceId}</div>
                        </div>
                    </div>
                    
                    ${overrideInfo}
                    
                    <!-- Enhanced Control Buttons -->
                    <div style="margin-top: 15px;">
                        <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #2c3e50;">üí° LED Control</div>
                        
                        <!-- Duration Selection -->
                        <div style="margin-bottom: 10px;">
                            <select id="duration-${deviceId}" style="width: 100%; padding: 6px; border: 2px solid #ddd; border-radius: 4px; font-size: 12px; background: white;" ${!isOnline ? 'disabled' : ''}>
                                <option value="24h">24 Hours</option>
                                <option value="1h">1 Hour</option>
                                <option value="4h">4 Hours</option>
                                <option value="12h">12 Hours</option>
                                <option value="permanent">Permanent</option>
                            </select>
                        </div>
                        
                        <div class="control-buttons">
                            <button class="btn btn-on" onclick="sendOverrideCommand('${deviceId}', 'on')" style="flex: 1;" ${!isOnline ? 'disabled' : ''}>üí° LED ON</button>
                            <button class="btn btn-off" onclick="sendOverrideCommand('${deviceId}', 'off')" style="flex: 1;" ${!isOnline ? 'disabled' : ''}>üí° LED OFF</button>
                        </div>
                        <div style="margin-top: 8px;">
                            <button class="btn" onclick="removeOverride('${deviceId}')" ${!override?.active || !isOnline ? 'disabled' : ''} style="width: 100%; background: #6c757d; color: white; opacity: ${override?.active && isOnline ? '1' : '0.6'};">
                                ü§ñ AUTO MODE
                            </button>
                        </div>
                    </div>
                    
                    <div class="timestamp">üïí Last update: ${new Date().toLocaleTimeString()}</div>
                `;
            });
            
            // Update chart data
            updateChart(deviceId, data, timestamp);
        }
        
        // Update chart with new data
        function updateChart(deviceId, data, timestamp) {
            // Use current browser time for consistency
            const time = new Date().toLocaleTimeString();
            const consumption = data.room_usage || 0;
            const temperature = data.temperature || 0;
            const lux = data.lux || 0;
            const occupancy = data.occupancy || 0;
            
            // Update peak values
            if (consumption > chartPeaks.energy) {
                chartPeaks.energy = Math.ceil(consumption * 1.1 * 10) / 10; // Add 10% buffer and round up
                energyChart.options.scales.y.max = chartPeaks.energy;
            }
            
            if (temperature > chartPeaks.temperature) {
                chartPeaks.temperature = Math.ceil(temperature + 2); // Add 2¬∞C buffer
                temperatureChart.options.scales.y.max = chartPeaks.temperature;
            }
            
            if (lux > chartPeaks.light) {
                chartPeaks.light = Math.ceil(lux * 1.1 / 10) * 10; // Add 10% buffer and round to nearest 10
                lightChart.options.scales.y.max = chartPeaks.light;
            }
            
            let datasetIndex = -1;
            if (deviceId === 'node1') datasetIndex = 0;
            else if (deviceId === 'node2') datasetIndex = 1;
            else if (deviceId === 'node3') datasetIndex = 2;
            
            if (datasetIndex >= 0) {
                // Update Energy Chart
                const energyDataset = energyChart.data.datasets[datasetIndex];
                energyDataset.data.push(consumption);
                if (energyDataset.data.length > 20) {
                    energyDataset.data.shift();
                }
                
                // Update Temperature Chart
                const tempDataset = temperatureChart.data.datasets[datasetIndex];
                tempDataset.data.push(temperature);
                if (tempDataset.data.length > 20) {
                    tempDataset.data.shift();
                }
                
                // Update Light Chart
                const lightDataset = lightChart.data.datasets[datasetIndex];
                lightDataset.data.push(lux);
                if (lightDataset.data.length > 20) {
                    lightDataset.data.shift();
                }
                
                // Update Occupancy Chart
                const occupancyDataset = occupancyChart.data.datasets[datasetIndex];
                occupancyDataset.data.push(occupancy);
                if (occupancyDataset.data.length > 20) {
                    occupancyDataset.data.shift();
                }
            }
            
            // Update labels for all charts (only once per update)
            if (datasetIndex === 0) { // Only update labels from the first device to avoid duplicates
                energyChart.data.labels.push(time);
                if (energyChart.data.labels.length > 20) {
                    energyChart.data.labels.shift();
                }
                
                // Copy labels to other charts
                temperatureChart.data.labels = [...energyChart.data.labels];
                lightChart.data.labels = [...energyChart.data.labels];
                occupancyChart.data.labels = [...energyChart.data.labels];
                
                // Update all charts
                energyChart.update('none');
                temperatureChart.update('none');
                lightChart.update('none');
                occupancyChart.update('none');
            }
        }
        
        // Send LED control command
        function sendCommand(deviceId, command) {
            socket.emit('request_control', {
                device_id: deviceId,
                command: command
            });
        }
        
        // Fetch device override status
        async function fetchDeviceOverride(deviceId) {
            try {
                const response = await fetch('/api/devices');
                const devices = await response.json();
                return devices[deviceId]?.override || null;
            } catch (error) {
                console.error('Error fetching device override:', error);
                return null;
            }
        }
        
        // Send override command (like in control panel)
        function sendOverrideCommand(deviceId, command) {
            const durationSelect = document.getElementById(`duration-${deviceId}`);
            const duration = durationSelect ? durationSelect.value : '24h';
            
            const overrideData = {
                status: command,
                type: duration
            };
            
            fetch(`/api/devices/${deviceId}/override`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(overrideData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`‚úÖ Override set: ${deviceId} LED ${command.toUpperCase()} for ${duration}`);
                    // Refresh the card to show updated override status
                    setTimeout(() => {
                        fetch('/api/devices')
                            .then(response => response.json())
                            .then(devices => {
                                const deviceData = devices[deviceId];
                                if (deviceData) {
                                    updateSensorCard(deviceId, deviceData.latest_data, deviceData.latest_data.timestamp, 'sensor');
                                }
                            });
                    }, 1000);
                } else {
                    console.error(`‚ùå Override failed: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error(`‚ùå Override error: ${error.message}`);
            });
        }
        
        // Remove override (return to auto mode)
        function removeOverride(deviceId) {
            fetch(`/api/devices/${deviceId}/override`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`‚úÖ ${deviceId} returned to AUTO mode`);
                    // Refresh the card to show updated status
                    setTimeout(() => {
                        fetch('/api/devices')
                            .then(response => response.json())
                            .then(devices => {
                                const deviceData = devices[deviceId];
                                if (deviceData) {
                                    updateSensorCard(deviceId, deviceData.latest_data, deviceData.latest_data.timestamp, 'sensor');
                                }
                            });
                    }, 1000);
                } else {
                    console.error(`‚ùå Auto mode failed: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error(`‚ùå Auto mode error: ${error.message}`);
            });
        }
        
        // Global control functions
        function globalCommand(target, command) {
            const endpoint = target === 'all' ? 'devices/all/control' : `devices/${target}/control`;
            
            fetch(`/api/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: `all_${command}` })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showGlobalResponse(`‚úÖ ${command.toUpperCase()} command sent to all devices`, 'success');
                } else {
                    showGlobalResponse(`‚ùå Failed: ${data.error || 'Unknown error'}`, 'error');
                }
            })
            .catch(error => {
                showGlobalResponse(`‚ùå Error: ${error.message}`, 'error');
            });
        }
        
        function refreshOptimizer() {
            fetch('/api/system/refresh', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showGlobalResponse('üîÑ System refreshed successfully', 'success');
                } else {
                    showGlobalResponse(`‚ùå Refresh failed: ${data.error || 'Unknown error'}`, 'error');
                }
            })
            .catch(error => {
                showGlobalResponse(`‚ùå Refresh error: ${error.message}`, 'error');
            });
        }
        
        function enableOptimizer() {
            fetch('/api/devices/all/override/clear', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showGlobalResponse(`‚úÖ Optimizer re-enabled successfully! Cleared overrides for ${data.devices?.length || 0} devices`, 'success');
                } else {
                    showGlobalResponse(`‚ùå Enable failed: ${data.error || 'Unknown error'}`, 'error');
                }
            })
            .catch(error => {
                showGlobalResponse(`‚ùå Enable error: ${error.message}`, 'error');
            });
        }
        
        function showEnergyModeInfo() {
            const stats = document.getElementById('energy-saved').textContent;
            const events = document.getElementById('optimization-events').textContent;
            showGlobalResponse(
                `üìä Energy Statistics: ${stats} kWh saved through ${events} optimization events. The AI system automatically optimizes lighting based on occupancy, ambient light, and usage patterns.`, 
                'info'
            );
        }
        
        function resetChartScales() {
            // Reset peak values to defaults
            chartPeaks.energy = 0.2;
            chartPeaks.temperature = 30;
            chartPeaks.light = 100;
            chartPeaks.occupancy = 1.2;
            
            // Update chart scales
            energyChart.options.scales.y.max = chartPeaks.energy;
            temperatureChart.options.scales.y.max = chartPeaks.temperature;
            lightChart.options.scales.y.max = chartPeaks.light;
            
            // Update all charts
            energyChart.update();
            temperatureChart.update();
            lightChart.update();
            occupancyChart.update();
            
            showGlobalResponse('üìä Chart scales have been reset to default values', 'info');
        }
        
        function showGlobalResponse(message, type) {
            const responseEl = document.getElementById('global-response');
            responseEl.textContent = message;
            responseEl.className = `response-message ${type}`;
            responseEl.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                responseEl.style.display = 'none';
            }, 5000);
        }
        
        // Socket event handlers
        socket.on('connect', function() {
            console.log('Connected to server');
        });
        
        socket.on('system_status', function(data) {
            updateStatus(data);
            updateEnergyStats(data.energy_stats);
            
            // Update existing sensor cards
            Object.entries(data.latest_data || {}).forEach(([deviceId, deviceData]) => {
                updateSensorCard(deviceId, deviceData.data, deviceData.timestamp, deviceData.type);
            });
        });
        
        socket.on('sensor_update', function(data) {
            updateSensorCard(data.device_id, data.data, data.timestamp, data.type);
        });
        
        socket.on('control_response', function(data) {
            if (data.success) {
                console.log(`‚úÖ Command ${data.command} sent to ${data.device_id}`);
            } else {
                console.log(`‚ùå Failed to send command to ${data.device_id}`);
            }
        });
        
        // Initialize the page
        function initializePage() {
            console.log('üöÄ Initializing IoT Dashboard...');
            
            // Fetch initial data
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    console.log('üìä Initial data received:', data);
                    updateStatus(data);
                    updateEnergyStats(data.energy_stats);
                    
                    // Display initial sensor data
                    Object.entries(data.latest_data || {}).forEach(([deviceId, deviceInfo]) => {
                        console.log(`üì° Initializing device: ${deviceId}`, deviceInfo);
                        updateSensorCard(deviceId, deviceInfo.data, deviceInfo.timestamp, deviceInfo.type);
                    });
                })
                .catch(error => console.error('‚ùå Error fetching initial data:', error));
            
            // Set up real-time updates
            setInterval(() => {
                fetch('/api/status')
                    .then(response => response.json())
                    .then(data => {
                        console.log('üîÑ Real-time update:', new Date().toLocaleTimeString());
                        updateStatus(data);
                        updateEnergyStats(data.energy_stats);
                        
                        // Update sensor data
                        Object.entries(data.latest_data || {}).forEach(([deviceId, deviceInfo]) => {
                            updateSensorCard(deviceId, deviceInfo.data, deviceInfo.timestamp, deviceInfo.type);
                        });
                    })
                    .catch(error => console.error('‚ùå Error in real-time update:', error));
            }, 1000); // Update every 1 seconds
        }
        
        // Call initialization when page loads
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
